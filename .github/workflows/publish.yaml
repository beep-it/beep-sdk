name: Publish Packages

on:
  workflow_dispatch: # Manual triggering only

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # For npm provenance
    
    steps:
      - name: "Checkout"
        uses: "actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5"
        with:
          fetch-depth: 0

      - name: Use Node 22.18.0
        uses: actions/setup-node@8f152de45cc393bb48ce5d89d36b731f54556e65
        with:
          node-version: 22.18.0
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@3236b209b507b249883918e7c4c8c7cdd2c0d5db
        with:
          version: 10

      - name: Prepare
        run: |
          pnpm install --frozen-lockfile

      - name: Run Build
        run: |
          pnpm build

      - name: Run Unit Test
        run: |
          pnpm test

      - name: Publish to npm
        run: |
          # Publish packages in dependency order
          echo "Publishing @beep-it/sdk-core..."
          cd packages/core
          npm publish --provenance --access public
          cd ../..
          
          echo "Publishing @beep-it/checkout-widget..."
          cd packages/checkout-widget
          npm publish --provenance --access public
          cd ../..
          
          echo "Publishing @beep-it/cli..."
          cd packages/cli
          npm publish --provenance --access public
          cd ../..
          
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            ## ðŸš€ What's New
            
            - Updates and improvements to @beep-it packages
            - See individual package changelogs for details
            
            ## ðŸ“¦ Packages Published
            
            - `@beep-it/sdk-core@${{ github.ref_name }}`
            - `@beep-it/checkout-widget@${{ github.ref_name }}`  
            - `@beep-it/cli@${{ github.ref_name }}`
            
            ## Installation
            
            ```bash
            npm install @beep-it/sdk-core
            npm install @beep-it/checkout-widget
            npm install -g @beep-it/cli
            ```